# Проектирование информационной системы "Онлайн Магазин"

Ниже приведён один из вариантов ER-модели для описанной системы «Онлайн Магазин». В данном варианте учитываются следующие моменты:

- **Категории:** Все товары онлайн-магазина распределены по категориям. Каждая категория может содержать как товары, так и другие подкатегории (до 10 уровней вложенности). При просмотре товаров одной категории необходимо вывести все товары этой категории, а также товары всех её подкатегорий.
- **Товары:** Товары бывают двух типов: обычный товар и группа товаров.  
  - **Обычный товар** содержит имя и цену.  
  - **Группа товаров** содержит имя, перечень входящих товаров, а также способ расчёта цены.
- **Правила формирования цен групп товаров:**
  - Общая скидка в _N%_ от суммы всех товаров в группе.
  - Каждый _N-й_ товар в группе – бесплатный (выбирается самый дешёвый продукт).

---

# Диаграмма сущность-связь

![[../png/Диаграмма сущность-связь (БД)-Dark.png|1200]]
![]()
## Сущности
### Сущность "Категория" (Category)

| Атрибут                | Тип         | Описание                                                                                                                   |
| ---------------------- | ----------- | -------------------------------------------------------------------------------------------------------------------------- |
| **category_id**        | PK, UUID    | Уникальный идентификатор категории                                                                                         |
| **parent_category_id** | FK, UUID    | Идентификатор родительской категории (ссылается на `Category_id` в той же таблице, может быть NULL для корневых категорий) |
| **category_name**      | VARCHAR(50) | Название категории (ограничение в 50 символов - для упрощения последующего вывода на сайте/приложении)                     |

**Описание:** Рекурсивная связь через поле `parent_category_id` позволяет создавать неограниченное количество уровней вложенности подкатегорий.

### Сущность "Товар" (Product)

| Атрибут          | Тип                     | Описание                                                                                                  |
| ---------------- | ----------------------- | --------------------------------------------------------------------------------------------------------- |
| **product_id**   | PK, UUID                | Уникальный идентификатор товара                                                                           |
| **product_name** | VARCHAR(100)            | Название товара (ограничение в 100 символов - достаточно для заголовка товара в онлайн-магазине)          |
| **price**        | DECIMAL(5,2)            | Цена товара (для обычного товара – задана явно; для группы товаров – может вычисляться по заданной схеме) |
| **category_id**  | FK, UUID                | Идентификатор категории, к которой принадлежит товар (ссылка на `Category.category_id`)                   |
| **product_type** | ENUM('simple', 'group') | Тип товара, выбор из 2-х вариантов: (`simple` – обычный товар, `group` – группа товаров)                  |

**Обоснование:** Поле `product_type` позволяет различать обычный товар и группу товаров, при этом товары этих типов будут выводиться в одном списке по одному SQL запросу, фильтрация их также не вызовет проблем (например: `WHERE product_type = 'simple'`).

### Сущность "Состав группы" (GroupedProductItems)

| Атрибут                                 | Тип                | Описание                                                                                   |
| --------------------------------------- | ------------------ | ------------------------------------------------------------------------------------------ |
| **group_product_id, simple_product_id** | PK, Составной ключ | Обеспечивает уникальность комбинации "группа – товар"                                      |
| **group_product_id**                    | FK, UUID           | Идентификатор товара-группы (ссылка на `Product.product_id`, где `product_type = 'group'`) |
| **simple_product_id**                   | FK, UUID           | Идентификатор входящего в группу товара (ссылка на `Product.product_id`)                   |

**Обоснование:** Данная таблица реализует отношение «многие ко многим» между группой товаров и входящими в неё товарами. Это позволяет одной группе содержать несколько товаров, а один товар потенциально входить в несколько групп (если это требуется бизнес-логикой). Также упрощает изменение списка товаров в группах.

### Сущность "Стратегия ценообразования" (PricingStrategy)

| Атрибут                 | Тип          | Описание                                                                                    |
| ----------------------- | ------------ | ------------------------------------------------------------------------------------------- |
| **pricing_strategy_id** | PK, UUID     | Уникальный идентификатор стратегии                                                          |
| **name**                | VARCHAR(100) | Название стратегии (для удобства взаимодействия со стратегией в бэкэнде)                    |
| **description**         | TEXT         | Описание стратегии (для удобства взаимодействия)                                            |
| **discount_percentage** | INTEGER      | Скидка в % (может быть `NULL`, в зависимости от выбранной стратегии)                        |
| **free_Nth_product**    | INTEGER      | Номер бесплатного товара в группе (может быть `NULL`, в зависимости от выбранной стратегии) |

**Обоснование:** Данная таблица реализует отношение список стратегий ценообразования, в данном случае это упрощает работу для сотрудника-непрограммиста, возможно настройка создания, изменения и применения стратегий через стандартные методы в виде API. Такой количество параметров позволит создать некоторое количество стратегий (например: скидка на N-ый товар, кэшбэк, скидка по прогрессии). В последствии могут появиться стратегии, которые этими двумя параметрами не описать (например: скидка по таймеру, комбо сделка: А+Б дешевле), но изменение этой таблицы никак не затронет остальные, поэтому это не создаст проблем.

### Сущность "Стратегия ценообразования для товара" (PricingStrategyForProduct)

| Атрибут                             | Тип                | Описание                                                                            |
| ----------------------------------- | ------------------ | ----------------------------------------------------------------------------------- |
| **product_id, pricing_strategy_id** | PK, Составной ключ | Обеспечивает уникальность комбинации "стратегия – товар"                            |
| **product_id**                      | FK, UUID           | Идентификатор товара (ссылка на `Product.product_id`, где `product_type = 'group'`) |
| **pricing_strategy_id**             | FK, UUID           | Идентификатор стратегии (ссылка на `PricingStrategy.pricing_strategy_id`)           |

**Обоснование:** Данная таблица реализует отношение «многие ко многим» между группой товаров и стратегией ценообразования. Это позволяет одной группе включать в себя несколько стратегий (например если будет необходимость группу товаров продавать одновременно со скидкой и опцией каждый N-ый товар бесплатно, для повышения продаж, на чёрную пятницу и т.п.), а одна стратегия может быть применена к разным группам товаров (для этого они и нужны). Также эта таблица упрощает изменение стратегий на разных группах товаров.

## Связи

- **Category.category_id – Category.parent_category_id:**  Рекурсивная связь через `parent_category_id` позволяет организовать иерархию подкатегорий (связь "один ко многим"). В категории может быть много категорий или вообще ни одной. Родительская категория только одна. 
- **Category.Category_id – Product.category_id:** Каждый товар связан с конкретной категорией, категория может содержать несколько товаров (связь "один ко многим").
- **Product.product_id – GroupedProductItems.group_product_id:** Один товар входит во много групп. В поле `group_product_id` записывается `product_id` соответствующий `product_type = 'group'` (связь "многие ко многим").
- **Product.product_id – GroupedProductItems.simple_product_id:** Одна группа содержит много товаров. В поле `simple_product_id` записывается `product_id` соответствующий `product_type = 'simple'` (связь "многие ко многим").
- **Product.product_id – PricingStrategyForProduct.product_id:** Одна группа может иметь много стратегий. В поле `product_id` записывается `product_id` соответствующий `product_type = 'group'` (связь "многие ко многим").
- **PricingStrategy.pricing_strategy_id – PricingStrategyForProduct.pricing_strategy_id:** Одна стратегия может распространяться на много группа (связь "многие ко многим").

---

# Диаграмма классов

![[../png/Диаграмма классов-Dark.png|1000]]
## Классы

### Category

- `id`: идентификатор категории.
- `name`: название категории.
- `parent`: ссылка на родительскую категорию (может быть `null`, если это корневая категория).

- `get_all_products()`: возвращает все товары из данной категории и рекурсивно из подкатегорий (или с помощью специфической структуры в БД).

### Product (абстрактный класс)

- `id`, `name`: общие поля.

- `get_price()`: полиморфный метод (каждый конкретный вид товара считает цену по-своему).

### SimpleProduct (обычный товар)

- `price`: базовая цена товара.

- `get_price()`: возвращает цену без каких-либо дополнительных вычислений.

### GroupedProduct (группа товаров)

- `products: list(product)`: набор вложенных товаров (могут быть простыми, могут быть сами группами).
- `pricing_strategy: PricingStrategy`: указывает конкретный способ вычисления цены для группы.

- `get_price()`: делегирует вычисление методу `pricingStrategy.calcPrice(products)`.

### PricingStrategy (стратегия вычисления цены):

- Абстрактный метод `calc_price(list(product))`.

- Подклассы:
	- **PercentDiscount**: хранит процент `percent` и уменьшает суммарную стоимость всех вложенных товаров на данный процент.
	- **EveryNthFree**: хранит число `nth`, по которому «каждый N-й» товар идёт бесплатно, предварительно сортирует товары по цене, чтобы бесплатно шёл самый дешёвый, и возвращает сумму остальных.
	- И т.д. для любых других логик.


Таким образом, мы используем следующие паттерны проектирования:

- **Компоновщик** (Composite) для групп товаров и для категорий.
- **Стратегию** (Strategy) для вычисления цены в случае групповых товаров.